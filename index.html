<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoStudio Pro - 专业照片美化工具</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #161616;
            --bg-tertiary: #1a1a1a;
            --bg-panel: #141414;
            --bg-hover: #252525;
            --bg-active: #2a2a2a;
            --border-color: #2a2a2a;
            --border-light: #333;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --text-muted: #666;
            --accent-primary: #ff6b35;
            --accent-secondary: #00d4aa;
            --accent-blue: #4a9eff;
            --accent-purple: #a855f7;
            --accent-pink: #ec4899;
            --slider-track: #333;
            --slider-fill: #ff6b35;
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }

        /* App Layout */
        .app-container {
            display: grid;
            grid-template-rows: 56px 1fr 40px;
            height: 100vh;
            background: var(--bg-primary);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-pink));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--accent-primary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-light);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #ff7d4d;
            transform: translateY(-1px);
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            height: 100%;
            overflow: hidden;
        }

        /* Left Panel - Tools */
        .left-panel {
            background: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .panel-tab {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            border-bottom: 2px solid transparent;
        }

        .panel-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .panel-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .panel-section {
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .section-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            display: flex;
            transition: transform var(--transition-fast);
        }

        .section-toggle svg {
            width: 14px;
            height: 14px;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        /* Sliders */
        .slider-group {
            margin-bottom: 16px;
        }

        .slider-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .slider-label {
            font-size: 12px;
            color: var(--text-primary);
        }

        .slider-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--accent-primary);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            min-width: 40px;
            text-align: center;
        }

        .slider-container {
            position: relative;
            height: 4px;
            background: var(--slider-track);
            border-radius: 2px;
        }

        .slider-fill {
            position: absolute;
            height: 100%;
            background: var(--slider-fill);
            border-radius: 2px;
            transition: width var(--transition-fast);
        }

        input[type="range"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            top: 0;
            left: 0;
        }

        .slider-thumb {
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            pointer-events: none;
            transition: transform var(--transition-fast);
        }

        .slider-container:hover .slider-thumb {
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* Canvas Area */
        .canvas-area {
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .canvas-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 100%;
            max-height: 100%;
        }

        #imageCanvas {
            max-width: 100%;
            max-height: calc(100vh - 150px);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            transition: filter var(--transition-fast);
        }

        .drop-zone {
            position: absolute;
            inset: 20px;
            border: 2px dashed var(--border-light);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            background: var(--bg-secondary);
            transition: all var(--transition-normal);
        }

        .drop-zone.drag-over {
            border-color: var(--accent-primary);
            background: rgba(255, 107, 53, 0.05);
        }

        .drop-zone.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .drop-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-hover));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drop-icon svg {
            width: 40px;
            height: 40px;
            color: var(--text-secondary);
        }

        .drop-text {
            text-align: center;
        }

        .drop-text h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .drop-text p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .browse-btn {
            padding: 12px 24px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .browse-btn:hover {
            background: #ff7d4d;
            transform: translateY(-2px);
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .zoom-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .zoom-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .zoom-btn svg {
            width: 16px;
            height: 16px;
        }

        .zoom-level {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-primary);
            min-width: 50px;
            text-align: center;
        }

        /* Compare Toggle */
        .compare-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
            background: var(--bg-tertiary);
            border-radius: 11px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .toggle-switch.active {
            background: var(--accent-primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform var(--transition-fast);
        }

        .toggle-switch.active::after {
            transform: translateX(18px);
        }

        .toggle-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Right Panel - Presets */
        .right-panel {
            background: var(--bg-panel);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .preset-search {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            outline: none;
            transition: border-color var(--transition-fast);
        }

        .search-input:focus {
            border-color: var(--accent-primary);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .preset-categories {
            display: flex;
            padding: 12px 16px;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border-color);
        }

        .category-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }

        .category-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .category-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .preset-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .preset-section {
            margin-bottom: 20px;
        }

        .preset-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preset-section-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background: var(--accent-primary);
            border-radius: 2px;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .preset-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .preset-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .preset-card.active {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 1px var(--accent-primary);
        }

        .preset-preview {
            width: 100%;
            aspect-ratio: 4/3;
            background: linear-gradient(135deg, var(--bg-hover), var(--bg-secondary));
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            overflow: hidden;
        }

        .preset-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preset-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-primary);
            text-align: center;
        }

        /* Film Section */
        .film-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .film-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .film-card:hover {
            border-color: var(--accent-secondary);
            transform: translateY(-2px);
        }

        .film-card.active {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 0 1px var(--accent-secondary);
        }

        .film-brand {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-secondary);
            margin-bottom: 4px;
        }

        .film-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .film-type {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Intensity Slider */
        .intensity-control {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 16px;
        }

        .intensity-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .intensity-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .intensity-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--accent-secondary);
        }

        /* Footer */
        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            font-size: 11px;
            color: var(--text-muted);
        }

        .footer-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .footer-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .footer-stat svg {
            width: 14px;
            height: 14px;
        }

        /* History Panel */
        .history-panel {
            position: fixed;
            right: -400px;
            top: 56px;
            bottom: 40px;
            width: 400px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border-color);
            z-index: 200;
            transition: right var(--transition-normal);
            display: flex;
            flex-direction: column;
        }

        .history-panel.open {
            right: 0;
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .history-title {
            font-size: 14px;
            font-weight: 600;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        .close-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .history-item:hover {
            background: var(--bg-hover);
        }

        .history-thumb {
            width: 48px;
            height: 48px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .history-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .history-info {
            flex: 1;
        }

        .history-action {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .history-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Curve Editor */
        .curve-editor {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 12px;
        }

        .curve-canvas-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        #curveCanvas {
            width: 100%;
            height: 100%;
        }

        .curve-presets {
            display: flex;
            gap: 6px;
            margin-top: 12px;
        }

        .curve-preset {
            flex: 1;
            padding: 6px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .curve-preset:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .curve-preset.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        /* HSL Controls */
        .hsl-section {
            margin-top: 16px;
        }

        .hsl-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 3px;
            margin-bottom: 12px;
        }

        .hsl-tab {
            flex: 1;
            padding: 6px 8px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .hsl-tab:hover {
            color: var(--text-primary);
        }

        .hsl-tab.active {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .color-slider-group {
            margin-bottom: 12px;
        }

        .color-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .color-dot.red { background: #ef4444; }
        .color-dot.orange { background: #f97316; }
        .color-dot.yellow { background: #eab308; }
        .color-dot.green { background: #22c55e; }
        .color-dot.cyan { background: #06b6d4; }
        .color-dot.blue { background: #3b82f6; }
        .color-dot.purple { background: #8b5cf6; }
        .color-dot.magenta { background: #ec4899; }

        /* Split Toning */
        .split-toning {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .split-section {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .split-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .color-picker-wrapper {
            position: relative;
        }

        .color-picker-display {
            width: 100%;
            height: 36px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        input[type="color"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Plugin Section */
        .plugin-section {
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
            margin-top: 16px;
        }

        .plugin-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .plugin-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .plugin-icon svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .plugin-info {
            flex: 1;
        }

        .plugin-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .plugin-desc {
            font-size: 10px;
            color: var(--text-muted);
        }

        .plugin-toggle {
            width: 36px;
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            transition: background var(--transition-fast);
        }

        .plugin-toggle.active {
            background: var(--accent-purple);
        }

        .plugin-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform var(--transition-fast);
        }

        .plugin-toggle.active::after {
            transform: translateX(16px);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-normal);
        }

        .loading-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 11px;
            color: var(--text-primary);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        /* Keyboard Shortcuts */
        .keyboard-hint {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: auto;
        }

        /* Reset Button */
        .reset-btn {
            width: 100%;
            padding: 10px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-top: 16px;
        }

        .reset-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-light);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 260px 1fr 280px;
            }
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .left-panel, .right-panel {
                position: fixed;
                top: 56px;
                bottom: 40px;
                width: 300px;
                z-index: 150;
                transform: translateX(-100%);
                transition: transform var(--transition-normal);
            }
            
            .right-panel {
                right: 0;
                left: auto;
                transform: translateX(100%);
            }
            
            .left-panel.open {
                transform: translateX(0);
            }
            
            .right-panel.open {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M14.31 8l5.74 9.94M9.69 8h11.48M7.38 12l5.74-9.94M9.69 16L3.95 6.06M14.31 16H2.83M16.62 12l-5.74 9.94"/>
                    </svg>
                </div>
                <div class="logo-text">PhotoStudio <span>Pro</span></div>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-ghost" id="undoBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
                    </svg>
                    撤销
                </button>
                <button class="btn btn-ghost" id="redoBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/>
                    </svg>
                    重做
                </button>
                <button class="btn btn-ghost" id="historyBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/>
                    </svg>
                    历史
                </button>
                <button class="btn btn-primary" id="exportBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    导出
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Panel - Adjustments -->
            <aside class="left-panel" id="leftPanel">
                <div class="panel-tabs">
                    <button class="panel-tab active" data-tab="adjust">调色</button>
                    <button class="panel-tab" data-tab="curve">曲线</button>
                    <button class="panel-tab" data-tab="hsl">HSL</button>
                    <button class="panel-tab" data-tab="split">色彩分离</button>
                </div>

                <div class="panel-content" id="panelContent">
                    <!-- Basic Adjustments -->
                    <div class="panel-section" id="adjustPanel">
                        <div class="section-header">
                            <span class="section-title">基础调整</span>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">曝光</span>
                                <span class="slider-value" id="exposureValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="exposureFill" style="width: 50%; left: 0;"></div>
                                <div class="slider-thumb" id="exposureThumb" style="left: 50%;"></div>
                                <input type="range" id="exposure" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">对比度</span>
                                <span class="slider-value" id="contrastValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="contrastFill" style="width: 50%;"></div>
                                <div class="slider-thumb" id="contrastThumb" style="left: 50%;"></div>
                                <input type="range" id="contrast" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">高光</span>
                                <span class="slider-value" id="highlightsValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="highlightsFill" style="width: 50%;"></div>
                                <div class="slider-thumb" id="highlightsThumb" style="left: 50%;"></div>
                                <input type="range" id="highlights" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">阴影</span>
                                <span class="slider-value" id="shadowsValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="shadowsFill" style="width: 50%;"></div>
                                <div class="slider-thumb" id="shadowsThumb" style="left: 50%;"></div>
                                <input type="range" id="shadows" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">白色色阶</span>
                                <span class="slider-value" id="whitesValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="whitesFill" style="width: 50%;"></div>
                                <div class="slider-thumb" id="whitesThumb" style="left: 50%;"></div>
                                <input type="range" id="whites" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">黑色色阶</span>
                                <span class="slider-value" id="blacksValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="blacksFill" style="width: 50%;"></div>
                                <div class="slider-thumb" id="blacksThumb" style="left: 50%;"></div>
                                <input type="range" id="blacks" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="section-header" style="margin-top: 24px;">
                            <span class="section-title">色彩调整</span>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">色温</span>
                                <span class="slider-value" id="temperatureValue">0</span>
                            </div>
                            <div class="slider-container" style="background: linear-gradient(90deg, #4a9eff, #ff9f4a);">
                                <div class="slider-thumb" id="temperatureThumb" style="left: 50%;"></div>
                                <input type="range" id="temperature" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">色调</span>
                                <span class="slider-value" id="tintValue">0</span>
                            </div>
                            <div class="slider-container" style="background: linear-gradient(90deg, #22c55e, #ec4899);">
                                <div class="slider-thumb" id="tintThumb" style="left: 50%;"></div>
                                <input type="range" id="tint" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">自然饱和度</span>
                                <span class="slider-value" id="vibranceValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="vibranceFill" style="width: 50%;"></div>
                                <div class="slider-thumb" id="vibranceThumb" style="left: 50%;"></div>
                                <input type="range" id="vibrance" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">饱和度</span>
                                <span class="slider-value" id="saturationValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="saturationFill" style="width: 50%;"></div>
                                <div class="slider-thumb" id="saturationThumb" style="left: 50%;"></div>
                                <input type="range" id="saturation" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="section-header" style="margin-top: 24px;">
                            <span class="section-title">细节优化</span>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">清晰度</span>
                                <span class="slider-value" id="clarityValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="clarityFill" style="width: 50%;"></div>
                                <div class="slider-thumb" id="clarityThumb" style="left: 50%;"></div>
                                <input type="range" id="clarity" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">去朦胧</span>
                                <span class="slider-value" id="dehazeValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="dehazeFill" style="width: 50%;"></div>
                                <div class="slider-thumb" id="dehazeThumb" style="left: 50%;"></div>
                                <input type="range" id="dehaze" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">锐化</span>
                                <span class="slider-value" id="sharpenValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="sharpenFill" style="width: 0%;"></div>
                                <div class="slider-thumb" id="sharpenThumb" style="left: 0%;"></div>
                                <input type="range" id="sharpen" min="0" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">降噪</span>
                                <span class="slider-value" id="noiseReductionValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="noiseReductionFill" style="width: 0%;"></div>
                                <div class="slider-thumb" id="noiseReductionThumb" style="left: 0%;"></div>
                                <input type="range" id="noiseReduction" min="0" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">暗角</span>
                                <span class="slider-value" id="vignetteValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="vignetteFill" style="width: 50%;"></div>
                                <div class="slider-thumb" id="vignetteThumb" style="left: 50%;"></div>
                                <input type="range" id="vignette" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">颗粒感</span>
                                <span class="slider-value" id="grainValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-fill" id="grainFill" style="width: 0%;"></div>
                                <div class="slider-thumb" id="grainThumb" style="left: 0%;"></div>
                                <input type="range" id="grain" min="0" max="100" value="0">
                            </div>
                        </div>

                        <button class="reset-btn" id="resetBasic">重置所有调整</button>
                    </div>

                    <!-- Curve Panel -->
                    <div class="panel-section" id="curvePanel" style="display: none;">
                        <div class="section-header">
                            <span class="section-title">曲线调整</span>
                        </div>

                        <div class="curve-editor">
                            <div class="curve-canvas-wrapper">
                                <canvas id="curveCanvas"></canvas>
                            </div>
                            <div class="curve-presets">
                                <button class="curve-preset active" data-curve="rgb">RGB</button>
                                <button class="curve-preset" data-curve="red">红</button>
                                <button class="curve-preset" data-curve="green">绿</button>
                                <button class="curve-preset" data-curve="blue">蓝</button>
                            </div>
                        </div>

                        <div style="margin-top: 16px;">
                            <div class="section-header">
                                <span class="section-title">曲线预设</span>
                            </div>
                            <div class="curve-presets" style="flex-wrap: wrap;">
                                <button class="curve-preset" data-preset="linear">线性</button>
                                <button class="curve-preset" data-preset="contrast">高对比</button>
                                <button class="curve-preset" data-preset="fade">褪色</button>
                                <button class="curve-preset" data-preset="film">胶片</button>
                                <button class="curve-preset" data-preset="cross">交叉处理</button>
                                <button class="curve-preset" data-preset="vintage">复古</button>
                            </div>
                        </div>

                        <button class="reset-btn" id="resetCurve">重置曲线</button>
                    </div>

                    <!-- HSL Panel -->
                    <div class="panel-section" id="hslPanel" style="display: none;">
                        <div class="section-header">
                            <span class="section-title">HSL 调整</span>
                        </div>

                        <div class="hsl-section">
                            <div class="hsl-tabs">
                                <button class="hsl-tab active" data-hsl="hue">色相</button>
                                <button class="hsl-tab" data-hsl="sat">饱和度</button>
                                <button class="hsl-tab" data-hsl="lum">亮度</button>
                            </div>

                            <div id="hslControls">
                                <!-- Red -->
                                <div class="color-slider-group">
                                    <div class="color-label">
                                        <span class="color-dot red"></span>
                                        <span class="slider-label">红色</span>
                                        <span class="slider-value" id="redHueValue">0</span>
                                    </div>
                                    <div class="slider-container">
                                        <div class="slider-thumb" id="redHueThumb" style="left: 50%;"></div>
                                        <input type="range" id="redHue" min="-100" max="100" value="0" data-color="red">
                                    </div>
                                </div>

                                <!-- Orange -->
                                <div class="color-slider-group">
                                    <div class="color-label">
                                        <span class="color-dot orange"></span>
                                        <span class="slider-label">橙色</span>
                                        <span class="slider-value" id="orangeHueValue">0</span>
                                    </div>
                                    <div class="slider-container">
                                        <div class="slider-thumb" id="orangeHueThumb" style="left: 50%;"></div>
                                        <input type="range" id="orangeHue" min="-100" max="100" value="0" data-color="orange">
                                    </div>
                                </div>

                                <!-- Yellow -->
                                <div class="color-slider-group">
                                    <div class="color-label">
                                        <span class="color-dot yellow"></span>
                                        <span class="slider-label">黄色</span>
                                        <span class="slider-value" id="yellowHueValue">0</span>
                                    </div>
                                    <div class="slider-container">
                                        <div class="slider-thumb" id="yellowHueThumb" style="left: 50%;"></div>
                                        <input type="range" id="yellowHue" min="-100" max="100" value="0" data-color="yellow">
                                    </div>
                                </div>

                                <!-- Green -->
                                <div class="color-slider-group">
                                    <div class="color-label">
                                        <span class="color-dot green"></span>
                                        <span class="slider-label">绿色</span>
                                        <span class="slider-value" id="greenHueValue">0</span>
                                    </div>
                                    <div class="slider-container">
                                        <div class="slider-thumb" id="greenHueThumb" style="left: 50%;"></div>
                                        <input type="range" id="greenHue" min="-100" max="100" value="0" data-color="green">
                                    </div>
                                </div>

                                <!-- Cyan -->
                                <div class="color-slider-group">
                                    <div class="color-label">
                                        <span class="color-dot cyan"></span>
                                        <span class="slider-label">青色</span>
                                        <span class="slider-value" id="cyanHueValue">0</span>
                                    </div>
                                    <div class="slider-container">
                                        <div class="slider-thumb" id="cyanHueThumb" style="left: 50%;"></div>
                                        <input type="range" id="cyanHue" min="-100" max="100" value="0" data-color="cyan">
                                    </div>
                                </div>

                                <!-- Blue -->
                                <div class="color-slider-group">
                                    <div class="color-label">
                                        <span class="color-dot blue"></span>
                                        <span class="slider-label">蓝色</span>
                                        <span class="slider-value" id="blueHueValue">0</span>
                                    </div>
                                    <div class="slider-container">
                                        <div class="slider-thumb" id="blueHueThumb" style="left: 50%;"></div>
                                        <input type="range" id="blueHue" min="-100" max="100" value="0" data-color="blue">
                                    </div>
                                </div>

                                <!-- Purple -->
                                <div class="color-slider-group">
                                    <div class="color-label">
                                        <span class="color-dot purple"></span>
                                        <span class="slider-label">紫色</span>
                                        <span class="slider-value" id="purpleHueValue">0</span>
                                    </div>
                                    <div class="slider-container">
                                        <div class="slider-thumb" id="purpleHueThumb" style="left: 50%;"></div>
                                        <input type="range" id="purpleHue" min="-100" max="100" value="0" data-color="purple">
                                    </div>
                                </div>

                                <!-- Magenta -->
                                <div class="color-slider-group">
                                    <div class="color-label">
                                        <span class="color-dot magenta"></span>
                                        <span class="slider-label">洋红</span>
                                        <span class="slider-value" id="magentaHueValue">0</span>
                                    </div>
                                    <div class="slider-container">
                                        <div class="slider-thumb" id="magentaHueThumb" style="left: 50%;"></div>
                                        <input type="range" id="magentaHue" min="-100" max="100" value="0" data-color="magenta">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button class="reset-btn" id="resetHSL">重置 HSL</button>
                    </div>

                    <!-- Split Toning Panel -->
                    <div class="panel-section" id="splitPanel" style="display: none;">
                        <div class="section-header">
                            <span class="section-title">色彩分离</span>
                        </div>

                        <div class="split-toning">
                            <div class="split-section">
                                <div class="split-label">高光色调</div>
                                <div class="color-picker-wrapper">
                                    <div class="color-picker-display" id="highlightColorDisplay" style="background: #ffaa00;"></div>
                                    <input type="color" id="highlightColor" value="#ffaa00">
                                </div>
                                <div class="slider-group" style="margin-top: 12px;">
                                    <div class="slider-header">
                                        <span class="slider-label">强度</span>
                                        <span class="slider-value" id="highlightToneValue">0</span>
                                    </div>
                                    <div class="slider-container">
                                        <div class="slider-fill" id="highlightToneFill" style="width: 0%;"></div>
                                        <div class="slider-thumb" id="highlightToneThumb" style="left: 0%;"></div>
                                        <input type="range" id="highlightTone" min="0" max="100" value="0">
                                    </div>
                                </div>
                            </div>

                            <div class="split-section">
                                <div class="split-label">阴影色调</div>
                                <div class="color-picker-wrapper">
                                    <div class="color-picker-display" id="shadowColorDisplay" style="background: #0066ff;"></div>
                                    <input type="color" id="shadowColor" value="#0066ff">
                                </div>
                                <div class="slider-group" style="margin-top: 12px;">
                                    <div class="slider-header">
                                        <span class="slider-label">强度</span>
                                        <span class="slider-value" id="shadowToneValue">0</span>
                                    </div>
                                    <div class="slider-container">
                                        <div class="slider-fill" id="shadowToneFill" style="width: 0%;"></div>
                                        <div class="slider-thumb" id="shadowToneThumb" style="left: 0%;"></div>
                                        <input type="range" id="shadowTone" min="0" max="100" value="0">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="slider-group" style="margin-top: 16px;">
                            <div class="slider-header">
                                <span class="slider-label">平衡</span>
                                <span class="slider-value" id="toneBalanceValue">0</span>
                            </div>
                            <div class="slider-container">
                                <div class="slider-thumb" id="toneBalanceThumb" style="left: 50%;"></div>
                                <input type="range" id="toneBalance" min="-100" max="100" value="0">
                            </div>
                        </div>

                        <button class="reset-btn" id="resetSplit">重置色彩分离</button>
                    </div>
                </div>
            </aside>

            <!-- Canvas Area -->
            <section class="canvas-area">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <canvas id="imageCanvas"></canvas>
                </div>

                <div class="drop-zone" id="dropZone">
                    <div class="drop-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21,15 16,10 5,21"/>
                        </svg>
                    </div>
                    <div class="drop-text">
                        <h3>拖拽图片到这里</h3>
                        <p>支持 JPG、PNG、WebP 格式</p>
                    </div>
                    <button class="browse-btn" id="browseBtn">选择文件</button>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>

                <div class="compare-toggle" id="compareToggle" style="display: none;">
                    <div class="toggle-switch" id="compareSwitch"></div>
                    <span class="toggle-label">对比原图</span>
                </div>

                <div class="zoom-controls" id="zoomControls" style="display: none;">
                    <button class="zoom-btn" id="zoomOut">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomIn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <button class="zoom-btn" id="zoomFit">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                        </svg>
                    </button>
                </div>
            </section>

            <!-- Right Panel - Presets & Films -->
            <aside class="right-panel" id="rightPanel">
                <div class="preset-search">
                    <input type="text" class="search-input" placeholder="搜索滤镜或胶片..." id="presetSearch">
                </div>

                <div class="preset-categories">
                    <button class="category-btn active" data-category="all">全部</button>
                    <button class="category-btn" data-category="filters">滤镜</button>
                    <button class="category-btn" data-category="film">胶片</button>
                    <button class="category-btn" data-category="bw">黑白</button>
                    <button class="category-btn" data-category="vintage">复古</button>
                </div>

                <div class="preset-list" id="presetList">
                    <!-- Filters Section -->
                    <div class="preset-section" data-type="filters">
                        <div class="preset-section-title">流行滤镜</div>
                        <div class="preset-grid" id="filtersGrid">
                            <!-- Filters will be generated by JS -->
                        </div>
                    </div>

                    <!-- Film Section - Fujifilm -->
                    <div class="preset-section" data-type="film">
                        <div class="preset-section-title">富士 Fujifilm</div>
                        <div class="film-grid" id="fujiGrid">
                            <!-- Films will be generated by JS -->
                        </div>
                    </div>

                    <!-- Film Section - Kodak -->
                    <div class="preset-section" data-type="film">
                        <div class="preset-section-title">柯达 Kodak</div>
                        <div class="film-grid" id="kodakGrid">
                            <!-- Films will be generated by JS -->
                        </div>
                    </div>

                    <!-- Film Section - Hasselblad -->
                    <div class="preset-section" data-type="film">
                        <div class="preset-section-title">哈苏 Hasselblad</div>
                        <div class="film-grid" id="hasselbladGrid">
                            <!-- Films will be generated by JS -->
                        </div>
                    </div>

                    <!-- Film Section - Ilford -->
                    <div class="preset-section" data-type="film bw">
                        <div class="preset-section-title">依尔福 Ilford (黑白)</div>
                        <div class="film-grid" id="ilfordGrid">
                            <!-- Films will be generated by JS -->
                        </div>
                    </div>

                    <!-- Film Section - Agfa -->
                    <div class="preset-section" data-type="film vintage">
                        <div class="preset-section-title">爱克发 Agfa</div>
                        <div class="film-grid" id="agfaGrid">
                            <!-- Films will be generated by JS -->
                        </div>
                    </div>

                    <!-- Film Section - Cinematic -->
                    <div class="preset-section" data-type="film">
                        <div class="preset-section-title">电影胶片</div>
                        <div class="film-grid" id="cinematicGrid">
                            <!-- Films will be generated by JS -->
                        </div>
                    </div>

                    <!-- Plugin Section -->
                    <div class="plugin-section">
                        <div class="section-header">
                            <span class="section-title">插件扩展</span>
                        </div>

                        <div class="plugin-card">
                            <div class="plugin-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <div class="plugin-info">
                                <div class="plugin-name">AI 智能增强</div>
                                <div class="plugin-desc">一键智能优化照片</div>
                            </div>
                            <div class="plugin-toggle active" data-plugin="ai"></div>
                        </div>

                        <div class="plugin-card">
                            <div class="plugin-icon" style="background: linear-gradient(135deg, #06b6d4, #3b82f6);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/>
                                </svg>
                            </div>
                            <div class="plugin-info">
                                <div class="plugin-name">背景模糊</div>
                                <div class="plugin-desc">模拟景深效果</div>
                            </div>
                            <div class="plugin-toggle" data-plugin="blur"></div>
                        </div>

                        <div class="plugin-card">
                            <div class="plugin-icon" style="background: linear-gradient(135deg, #f97316, #eab308);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                                </svg>
                            </div>
                            <div class="plugin-info">
                                <div class="plugin-name">光晕效果</div>
                                <div class="plugin-desc">添加柔和光晕</div>
                            </div>
                            <div class="plugin-toggle" data-plugin="glow"></div>
                        </div>

                        <div class="plugin-card">
                            <div class="plugin-icon" style="background: linear-gradient(135deg, #22c55e, #06b6d4);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                                </svg>
                            </div>
                            <div class="plugin-info">
                                <div class="plugin-name">自定义插件</div>
                                <div class="plugin-desc">导入第三方插件</div>
                            </div>
                            <div class="plugin-toggle" data-plugin="custom"></div>
                        </div>
                    </div>
                </div>

                <div class="intensity-control">
                    <div class="intensity-header">
                        <span class="intensity-label">效果强度</span>
                        <span class="intensity-value" id="intensityValue">100%</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-fill" id="intensityFill" style="width: 100%; background: var(--accent-secondary);"></div>
                        <div class="slider-thumb" id="intensityThumb" style="left: 100%;"></div>
                        <input type="range" id="intensity" min="0" max="100" value="100">
                    </div>
                </div>
            </aside>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-info">
                <div class="footer-stat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    </svg>
                    <span id="imageSize">--</span>
                </div>
                <div class="footer-stat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                        <circle cx="12" cy="13" r="3"/>
                    </svg>
                    <span id="colorSpace">--</span>
                </div>
            </div>
            <div>PhotoStudio Pro v1.0 | Powered by Canvas API</div>
        </footer>
    </div>

    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <span class="history-title">编辑历史</span>
            <button class="close-btn" id="closeHistory">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="history-list" id="historyList">
            <p style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 20px;">
                编辑历史将在此显示
            </p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">处理中...</div>
    </div>

    <script>
        // PhotoStudio Pro - Main Application
        class PhotoStudio {
            constructor() {
                this.canvas = document.getElementById('imageCanvas');
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
                this.originalImage = null;
                this.currentImageData = null;
                this.zoom = 1;
                this.history = [];
                this.historyIndex = -1;
                this.isComparing = false;
                
                // Adjustment values
                this.adjustments = {
                    // Basic
                    exposure: 0,
                    contrast: 0,
                    highlights: 0,
                    shadows: 0,
                    whites: 0,
                    blacks: 0,
                    // Color
                    temperature: 0,
                    tint: 0,
                    vibrance: 0,
                    saturation: 0,
                    // Details
                    clarity: 0,
                    dehaze: 0,
                    sharpen: 0,
                    noiseReduction: 0,
                    vignette: 0,
                    grain: 0,
                    // HSL
                    hsl: {
                        red: { hue: 0, sat: 0, lum: 0 },
                        orange: { hue: 0, sat: 0, lum: 0 },
                        yellow: { hue: 0, sat: 0, lum: 0 },
                        green: { hue: 0, sat: 0, lum: 0 },
                        cyan: { hue: 0, sat: 0, lum: 0 },
                        blue: { hue: 0, sat: 0, lum: 0 },
                        purple: { hue: 0, sat: 0, lum: 0 },
                        magenta: { hue: 0, sat: 0, lum: 0 }
                    },
                    // Split Toning
                    highlightColor: '#ffaa00',
                    highlightTone: 0,
                    shadowColor: '#0066ff',
                    shadowTone: 0,
                    toneBalance: 0,
                    // Preset
                    currentPreset: null,
                    presetIntensity: 100,
                    // Curve
                    curve: {
                        rgb: [[0, 0], [255, 255]],
                        red: [[0, 0], [255, 255]],
                        green: [[0, 0], [255, 255]],
                        blue: [[0, 0], [255, 255]]
                    }
                };
                
                this.initFilters();
                this.initFilms();
                this.initEventListeners();
                this.initCurveEditor();
            }

            initFilters() {
                this.filters = [
                    { id: 'natural', name: '自然', settings: { saturation: 5, contrast: 5, clarity: 10 } },
                    { id: 'vivid', name: '鲜艳', settings: { saturation: 30, vibrance: 20, contrast: 10 } },
                    { id: 'dramatic', name: '戏剧', settings: { contrast: 40, clarity: 30, highlights: -20, shadows: 20 } },
                    { id: 'moody', name: '情绪', settings: { contrast: 20, saturation: -10, temperature: -15, shadows: 15 } },
                    { id: 'warm', name: '暖调', settings: { temperature: 30, tint: 10, saturation: 10 } },
                    { id: 'cool', name: '冷调', settings: { temperature: -25, tint: -5, saturation: 5 } },
                    { id: 'fade', name: '褪色', settings: { contrast: -15, blacks: 20, saturation: -15 } },
                    { id: 'matte', name: '哑光', settings: { contrast: -10, blacks: 25, clarity: -10 } },
                    { id: 'retro', name: '复古', settings: { temperature: 15, saturation: -10, vignette: -30, grain: 20 } },
                    { id: 'cinematic', name: '电影', settings: { contrast: 15, temperature: -10, tint: 5, vignette: -20 } },
                    { id: 'golden', name: '金色时刻', settings: { temperature: 35, exposure: 5, highlights: -10, shadows: 15 } },
                    { id: 'arctic', name: '极地', settings: { temperature: -40, contrast: 20, clarity: 15 } }
                ];

                const grid = document.getElementById('filtersGrid');
                this.filters.forEach(filter => {
                    const card = document.createElement('div');
                    card.className = 'preset-card';
                    card.dataset.filter = filter.id;
                    card.innerHTML = `
                        <div class="preset-preview"></div>
                        <div class="preset-name">${filter.name}</div>
                    `;
                    card.addEventListener('click', () => this.applyFilter(filter));
                    grid.appendChild(card);
                });
            }

            initFilms() {
                this.films = {
                    fuji: [
                        { id: 'velvia50', name: 'Velvia 50', type: '高饱和正片', settings: { saturation: 35, contrast: 20, vibrance: 25, temperature: 5 } },
                        { id: 'velvia100', name: 'Velvia 100', type: '高饱和正片', settings: { saturation: 40, contrast: 25, vibrance: 30 } },
                        { id: 'provia100f', name: 'Provia 100F', type: '标准正片', settings: { saturation: 10, contrast: 10, clarity: 5 } },
                        { id: 'astia100f', name: 'Astia 100F', type: '柔和正片', settings: { saturation: 5, contrast: 5, vibrance: 10 } },
                        { id: 'pro400h', name: 'Pro 400H', type: '专业负片', settings: { saturation: -5, temperature: 5, tint: 5, contrast: -5 } },
                        { id: 'superia400', name: 'Superia 400', type: '消费负片', settings: { saturation: 15, temperature: 10, contrast: 5, grain: 10 } },
                        { id: 'c200', name: 'C200', type: '经济负片', settings: { saturation: 10, temperature: 15, contrast: 0, grain: 15 } },
                        { id: 'classic_chrome', name: 'Classic Chrome', type: '经典正片', settings: { saturation: -15, contrast: 15, temperature: -5, blacks: 10 } }
                    ],
                    kodak: [
                        { id: 'portra160', name: 'Portra 160', type: '人像负片', settings: { saturation: -5, contrast: -5, temperature: 10, highlights: -10 } },
                        { id: 'portra400', name: 'Portra 400', type: '人像负片', settings: { saturation: 0, contrast: -3, temperature: 8, shadows: 10 } },
                        { id: 'portra800', name: 'Portra 800', type: '高感负片', settings: { saturation: 5, contrast: 0, temperature: 12, grain: 15 } },
                        { id: 'ektar100', name: 'Ektar 100', type: '风光负片', settings: { saturation: 25, contrast: 15, vibrance: 20 } },
                        { id: 'gold200', name: 'Gold 200', type: '消费负片', settings: { saturation: 15, temperature: 20, contrast: 5, grain: 10 } },
                        { id: 'ultramax400', name: 'UltraMax 400', type: '消费负片', settings: { saturation: 20, temperature: 15, contrast: 10, grain: 12 } },
                        { id: 'colorplus200', name: 'ColorPlus 200', type: '经济负片', settings: { saturation: 10, temperature: 18, contrast: 5, grain: 18 } },
                        { id: 'ektachrome', name: 'Ektachrome E100', type: '正片', settings: { saturation: 20, contrast: 15, clarity: 10, temperature: -5 } }
                    ],
                    hasselblad: [
                        { id: 'hb_natural', name: 'Natural', type: '自然色彩', settings: { saturation: 5, contrast: 8, clarity: 5 } },
                        { id: 'hb_portrait', name: 'Portrait', type: '人像模式', settings: { saturation: -5, contrast: -5, temperature: 8, clarity: -5 } },
                        { id: 'hb_landscape', name: 'Landscape', type: '风光模式', settings: { saturation: 15, contrast: 12, clarity: 15, dehaze: 10 } },
                        { id: 'hb_vibrant', name: 'Vibrant', type: '鲜艳模式', settings: { saturation: 25, vibrance: 20, contrast: 10 } },
                        { id: 'hb_soft', name: 'Soft', type: '柔和模式', settings: { saturation: 0, contrast: -10, clarity: -15, highlights: -15 } },
                        { id: 'hb_xpan', name: 'XPAN', type: '经典模式', settings: { saturation: -10, contrast: 20, temperature: -5, vignette: -15 } }
                    ],
                    ilford: [
                        { id: 'hp5', name: 'HP5 Plus', type: 'ISO 400', settings: { saturation: -100, contrast: 20, grain: 15 } },
                        { id: 'delta100', name: 'Delta 100', type: 'ISO 100', settings: { saturation: -100, contrast: 25, grain: 5, clarity: 10 } },
                        { id: 'delta400', name: 'Delta 400', type: 'ISO 400', settings: { saturation: -100, contrast: 22, grain: 12 } },
                        { id: 'delta3200', name: 'Delta 3200', type: 'ISO 3200', settings: { saturation: -100, contrast: 18, grain: 35 } },
                        { id: 'fp4', name: 'FP4 Plus', type: 'ISO 125', settings: { saturation: -100, contrast: 20, grain: 8, clarity: 5 } },
                        { id: 'panf', name: 'Pan F Plus', type: 'ISO 50', settings: { saturation: -100, contrast: 30, grain: 3, clarity: 15 } },
                        { id: 'sfx200', name: 'SFX 200', type: '红外', settings: { saturation: -100, contrast: 35, blacks: -10, whites: 10 } },
                        { id: 'xp2', name: 'XP2 Super', type: 'C41 黑白', settings: { saturation: -100, contrast: 15, grain: 10, shadows: 10 } }
                    ],
                    agfa: [
                        { id: 'vista200', name: 'Vista 200', type: '消费负片', settings: { saturation: 20, temperature: 15, contrast: 10, grain: 12 } },
                        { id: 'vista400', name: 'Vista 400', type: '消费负片', settings: { saturation: 18, temperature: 12, contrast: 8, grain: 18 } },
                        { id: 'ultra50', name: 'Ultra 50', type: '高饱和', settings: { saturation: 35, contrast: 20, vibrance: 25 } },
                        { id: 'optima100', name: 'Optima 100', type: '标准负片', settings: { saturation: 10, temperature: 8, contrast: 5 } },
                        { id: 'precisa100', name: 'Precisa CT100', type: '正片', settings: { saturation: 15, contrast: 15, clarity: 8 } },
                        { id: 'apx100', name: 'APX 100', type: '黑白', settings: { saturation: -100, contrast: 22, grain: 8 } }
                    ],
                    cinematic: [
                        { id: 'vision3_50d', name: 'Vision3 50D', type: '日光型', settings: { saturation: 5, contrast: 10, temperature: 0, clarity: 5 } },
                        { id: 'vision3_250d', name: 'Vision3 250D', type: '日光型', settings: { saturation: 8, contrast: 12, temperature: 5, grain: 5 } },
                        { id: 'vision3_500t', name: 'Vision3 500T', type: '钨丝灯型', settings: { saturation: 5, contrast: 15, temperature: -10, grain: 8 } },
                        { id: 'cinestill800t', name: 'CineStill 800T', type: '钨丝灯', settings: { saturation: 10, contrast: 12, temperature: -15, grain: 12 } },
                        { id: 'cinestill50d', name: 'CineStill 50D', type: '日光型', settings: { saturation: 12, contrast: 15, temperature: 5 } },
                        { id: 'teal_orange', name: 'Teal & Orange', type: '好莱坞风格', settings: { temperature: 10, tint: -5, saturation: 15, contrast: 15 } },
                        { id: 'bleach_bypass', name: 'Bleach Bypass', type: '漂白跳过', settings: { saturation: -30, contrast: 35, clarity: 20 } },
                        { id: 'cross_process', name: 'Cross Process', type: '交叉冲洗', settings: { saturation: 20, contrast: 25, temperature: -20, tint: 15 } }
                    ]
                };

                // Render film grids
                Object.entries(this.films).forEach(([brand, films]) => {
                    const gridId = brand === 'fuji' ? 'fujiGrid' : 
                                   brand === 'hasselblad' ? 'hasselbladGrid' :
                                   brand === 'ilford' ? 'ilfordGrid' :
                                   brand === 'agfa' ? 'agfaGrid' :
                                   brand === 'cinematic' ? 'cinematicGrid' : 'kodakGrid';
                    const grid = document.getElementById(gridId);
                    
                    films.forEach(film => {
                        const card = document.createElement('div');
                        card.className = 'film-card';
                        card.dataset.film = film.id;
                        card.innerHTML = `
                            <div class="film-brand">${brand.toUpperCase()}</div>
                            <div class="film-name">${film.name}</div>
                            <div class="film-type">${film.type}</div>
                        `;
                        card.addEventListener('click', () => this.applyFilm(film, brand));
                        grid.appendChild(card);
                    });
                });
            }

            initEventListeners() {
                // File input
                const fileInput = document.getElementById('fileInput');
                const browseBtn = document.getElementById('browseBtn');
                const dropZone = document.getElementById('dropZone');

                browseBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));

                // Drag and drop
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.handleFile(file);
                    }
                });

                // Panel tabs
                document.querySelectorAll('.panel-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchPanel(tab.dataset.tab));
                });

                // HSL tabs
                document.querySelectorAll('.hsl-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchHSLTab(tab.dataset.hsl));
                });

                // All sliders
                this.initSliders();

                // Zoom controls
                document.getElementById('zoomIn').addEventListener('click', () => this.setZoom(this.zoom + 0.25));
                document.getElementById('zoomOut').addEventListener('click', () => this.setZoom(this.zoom - 0.25));
                document.getElementById('zoomFit').addEventListener('click', () => this.setZoom(1));

                // Compare toggle
                const compareSwitch = document.getElementById('compareSwitch');
                compareSwitch.addEventListener('click', () => {
                    this.isComparing = !this.isComparing;
                    compareSwitch.classList.toggle('active', this.isComparing);
                    this.render();
                });

                // History panel
                document.getElementById('historyBtn').addEventListener('click', () => {
                    document.getElementById('historyPanel').classList.add('open');
                });

                document.getElementById('closeHistory').addEventListener('click', () => {
                    document.getElementById('historyPanel').classList.remove('open');
                });

                // Undo/Redo
                document.getElementById('undoBtn').addEventListener('click', () => this.undo());
                document.getElementById('redoBtn').addEventListener('click', () => this.redo());

                // Export
                document.getElementById('exportBtn').addEventListener('click', () => this.exportImage());

                // Reset buttons
                document.getElementById('resetBasic').addEventListener('click', () => this.resetAdjustments());
                document.getElementById('resetCurve')?.addEventListener('click', () => this.resetCurve());
                document.getElementById('resetHSL')?.addEventListener('click', () => this.resetHSL());
                document.getElementById('resetSplit')?.addEventListener('click', () => this.resetSplitToning());

                // Category filter
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.filterPresets(btn.dataset.category));
                });

                // Preset search
                document.getElementById('presetSearch').addEventListener('input', (e) => {
                    this.searchPresets(e.target.value);
                });

                // Color pickers
                document.getElementById('highlightColor').addEventListener('input', (e) => {
                    this.adjustments.highlightColor = e.target.value;
                    document.getElementById('highlightColorDisplay').style.background = e.target.value;
                    this.render();
                });

                document.getElementById('shadowColor').addEventListener('input', (e) => {
                    this.adjustments.shadowColor = e.target.value;
                    document.getElementById('shadowColorDisplay').style.background = e.target.value;
                    this.render();
                });

                // Plugin toggles
                document.querySelectorAll('.plugin-toggle').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        toggle.classList.toggle('active');
                    });
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') {
                            e.preventDefault();
                            if (e.shiftKey) this.redo();
                            else this.undo();
                        } else if (e.key === 's') {
                            e.preventDefault();
                            this.exportImage();
                        }
                    }
                });
            }

            initSliders() {
                const sliderConfigs = [
                    // Basic
                    { id: 'exposure', centered: true },
                    { id: 'contrast', centered: true },
                    { id: 'highlights', centered: true },
                    { id: 'shadows', centered: true },
                    { id: 'whites', centered: true },
                    { id: 'blacks', centered: true },
                    // Color
                    { id: 'temperature', centered: true, special: true },
                    { id: 'tint', centered: true, special: true },
                    { id: 'vibrance', centered: true },
                    { id: 'saturation', centered: true },
                    // Details
                    { id: 'clarity', centered: true },
                    { id: 'dehaze', centered: true },
                    { id: 'sharpen', centered: false },
                    { id: 'noiseReduction', centered: false },
                    { id: 'vignette', centered: true },
                    { id: 'grain', centered: false },
                    // Split toning
                    { id: 'highlightTone', centered: false },
                    { id: 'shadowTone', centered: false },
                    { id: 'toneBalance', centered: true },
                    // Intensity
                    { id: 'intensity', centered: false, special: true }
                ];

                sliderConfigs.forEach(config => {
                    const slider = document.getElementById(config.id);
                    if (!slider) return;

                    slider.addEventListener('input', () => {
                        const value = parseInt(slider.value);
                        this.updateSliderUI(config.id, value, config.centered, config.special);
                        
                        if (config.id === 'intensity') {
                            this.adjustments.presetIntensity = value;
                        } else if (config.id.includes('Tone') || config.id === 'toneBalance') {
                            this.adjustments[config.id] = value;
                        } else {
                            this.adjustments[config.id] = value;
                        }
                        this.render();
                    });
                });

                // HSL sliders
                const colors = ['red', 'orange', 'yellow', 'green', 'cyan', 'blue', 'purple', 'magenta'];
                colors.forEach(color => {
                    const slider = document.getElementById(`${color}Hue`);
                    if (slider) {
                        slider.addEventListener('input', () => {
                            const value = parseInt(slider.value);
                            this.updateSliderUI(`${color}Hue`, value, true);
                            this.adjustments.hsl[color][this.currentHSLMode || 'hue'] = value;
                            this.render();
                        });
                    }
                });
            }

            updateSliderUI(id, value, centered, special) {
                const valueEl = document.getElementById(`${id}Value`);
                const fillEl = document.getElementById(`${id}Fill`);
                const thumbEl = document.getElementById(`${id}Thumb`);
                const slider = document.getElementById(id);

                if (valueEl) {
                    if (id === 'intensity') {
                        valueEl.textContent = value + '%';
                    } else {
                        valueEl.textContent = (value > 0 ? '+' : '') + value;
                    }
                }

                const min = parseInt(slider.min);
                const max = parseInt(slider.max);
                const range = max - min;
                const percent = ((value - min) / range) * 100;

                if (thumbEl) thumbEl.style.left = percent + '%';

                if (fillEl && !special) {
                    if (centered) {
                        const centerPercent = ((0 - min) / range) * 100;
                        if (value >= 0) {
                            fillEl.style.left = centerPercent + '%';
                            fillEl.style.width = (percent - centerPercent) + '%';
                        } else {
                            fillEl.style.left = percent + '%';
                            fillEl.style.width = (centerPercent - percent) + '%';
                        }
                    } else {
                        fillEl.style.left = '0';
                        fillEl.style.width = percent + '%';
                    }
                }
            }

            switchPanel(tab) {
                document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

                document.querySelectorAll('.panel-section').forEach(p => p.style.display = 'none');
                document.getElementById(`${tab}Panel`).style.display = 'block';
            }

            switchHSLTab(mode) {
                this.currentHSLMode = mode === 'sat' ? 'sat' : mode === 'lum' ? 'lum' : 'hue';
                document.querySelectorAll('.hsl-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-hsl="${mode}"]`).classList.add('active');

                // Update slider values for current mode
                const colors = ['red', 'orange', 'yellow', 'green', 'cyan', 'blue', 'purple', 'magenta'];
                colors.forEach(color => {
                    const slider = document.getElementById(`${color}Hue`);
                    const value = this.adjustments.hsl[color][this.currentHSLMode] || 0;
                    slider.value = value;
                    this.updateSliderUI(`${color}Hue`, value, true);
                });
            }

            handleFile(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.originalImage = img;
                        this.canvas.width = img.width;
                        this.canvas.height = img.height;
                        this.ctx.drawImage(img, 0, 0);
                        this.currentImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                        
                        document.getElementById('dropZone').classList.add('hidden');
                        document.getElementById('zoomControls').style.display = 'flex';
                        document.getElementById('compareToggle').style.display = 'flex';
                        
                        document.getElementById('imageSize').textContent = `${img.width} × ${img.height}`;
                        document.getElementById('colorSpace').textContent = 'sRGB';
                        
                        this.saveHistory('加载图片');
                        this.render();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            render() {
                if (!this.originalImage) return;

                // If comparing, show original
                if (this.isComparing) {
                    this.ctx.drawImage(this.originalImage, 0, 0);
                    return;
                }

                // Get original image data
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.originalImage.width;
                tempCanvas.height = this.originalImage.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(this.originalImage, 0, 0);
                let imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Apply adjustments
                imageData = this.applyAdjustments(imageData);
                
                // Draw to main canvas
                this.ctx.putImageData(imageData, 0, 0);
            }

            applyAdjustments(imageData) {
                const data = imageData.data;
                const adj = this.adjustments;
                const intensity = adj.presetIntensity / 100;

                // Create lookup tables for curves
                const curveLUT = this.createCurveLUT();

                for (let i = 0; i < data.length; i += 4) {
                    let r = data[i];
                    let g = data[i + 1];
                    let b = data[i + 2];

                    // Apply curves
                    r = curveLUT.rgb[curveLUT.red[r]];
                    g = curveLUT.rgb[curveLUT.green[g]];
                    b = curveLUT.rgb[curveLUT.blue[b]];

                    // Exposure
                    const expFactor = Math.pow(2, adj.exposure / 100);
                    r *= expFactor;
                    g *= expFactor;
                    b *= expFactor;

                    // Temperature (simplified)
                    if (adj.temperature !== 0) {
                        const temp = adj.temperature / 100;
                        r += temp * 30;
                        b -= temp * 30;
                    }

                    // Tint
                    if (adj.tint !== 0) {
                        const tintVal = adj.tint / 100;
                        g += tintVal * 20;
                    }

                    // Contrast
                    if (adj.contrast !== 0) {
                        const factor = (259 * (adj.contrast + 255)) / (255 * (259 - adj.contrast));
                        r = factor * (r - 128) + 128;
                        g = factor * (g - 128) + 128;
                        b = factor * (b - 128) + 128;
                    }

                    // Highlights and Shadows
                    const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
                    if (luminance > 128 && adj.highlights !== 0) {
                        const highlightFactor = 1 + (adj.highlights / 200) * ((luminance - 128) / 127);
                        r *= highlightFactor;
                        g *= highlightFactor;
                        b *= highlightFactor;
                    }
                    if (luminance < 128 && adj.shadows !== 0) {
                        const shadowFactor = 1 + (adj.shadows / 200) * ((128 - luminance) / 128);
                        r *= shadowFactor;
                        g *= shadowFactor;
                        b *= shadowFactor;
                    }

                    // Whites and Blacks
                    if (adj.whites !== 0) {
                        const whitesVal = adj.whites / 100;
                        r = r + (255 - r) * whitesVal * 0.1;
                        g = g + (255 - g) * whitesVal * 0.1;
                        b = b + (255 - b) * whitesVal * 0.1;
                    }
                    if (adj.blacks !== 0) {
                        const blacksVal = adj.blacks / 100;
                        r = r * (1 - blacksVal * 0.1);
                        g = g * (1 - blacksVal * 0.1);
                        b = b * (1 - blacksVal * 0.1);
                    }

                    // Convert to HSL for saturation/vibrance/HSL adjustments
                    let [h, s, l] = this.rgbToHsl(r, g, b);

                    // Vibrance (affects less saturated colors more)
                    if (adj.vibrance !== 0) {
                        const vibranceScale = 1 + (adj.vibrance / 100) * (1 - s);
                        s *= vibranceScale;
                    }

                    // Saturation
                    s *= 1 + adj.saturation / 100;

                    // HSL per-color adjustments
                    const colorAdjustments = this.getColorAdjustment(h, adj.hsl);
                    if (colorAdjustments) {
                        h += colorAdjustments.hue / 360;
                        s *= 1 + colorAdjustments.sat / 100;
                        l *= 1 + colorAdjustments.lum / 100;
                    }

                    // Clamp values
                    s = Math.max(0, Math.min(1, s));
                    l = Math.max(0, Math.min(1, l));
                    h = ((h % 1) + 1) % 1;

                    // Convert back to RGB
                    [r, g, b] = this.hslToRgb(h, s, l);

                    // Split toning
                    if (adj.highlightTone > 0 || adj.shadowTone > 0) {
                        const lum = 0.299 * r + 0.587 * g + 0.114 * b;
                        const balance = (adj.toneBalance + 100) / 200;

                        if (lum > 128 * (1 + balance) && adj.highlightTone > 0) {
                            const highlightRGB = this.hexToRgb(adj.highlightColor);
                            const blend = (adj.highlightTone / 100) * ((lum - 128) / 127) * 0.3;
                            r = r * (1 - blend) + highlightRGB.r * blend;
                            g = g * (1 - blend) + highlightRGB.g * blend;
                            b = b * (1 - blend) + highlightRGB.b * blend;
                        }

                        if (lum < 128 * balance && adj.shadowTone > 0) {
                            const shadowRGB = this.hexToRgb(adj.shadowColor);
                            const blend = (adj.shadowTone / 100) * ((128 - lum) / 128) * 0.3;
                            r = r * (1 - blend) + shadowRGB.r * blend;
                            g = g * (1 - blend) + shadowRGB.g * blend;
                            b = b * (1 - blend) + shadowRGB.b * blend;
                        }
                    }

                    // Clarity (local contrast)
                    if (adj.clarity !== 0) {
                        const clarityFactor = 1 + adj.clarity / 200;
                        const midGray = 128;
                        r = midGray + (r - midGray) * clarityFactor;
                        g = midGray + (g - midGray) * clarityFactor;
                        b = midGray + (b - midGray) * clarityFactor;
                    }

                    // Dehaze
                    if (adj.dehaze !== 0) {
                        const dehazeFactor = adj.dehaze / 100;
                        r = r + (r - 128) * dehazeFactor * 0.3;
                        g = g + (g - 128) * dehazeFactor * 0.3;
                        b = b + (b - 128) * dehazeFactor * 0.3;
                    }

                    // Clamp to valid range
                    data[i] = Math.max(0, Math.min(255, Math.round(r)));
                    data[i + 1] = Math.max(0, Math.min(255, Math.round(g)));
                    data[i + 2] = Math.max(0, Math.min(255, Math.round(b)));
                }

                // Apply post-processing effects
                if (adj.grain > 0) {
                    this.applyGrain(imageData, adj.grain);
                }

                if (adj.vignette !== 0) {
                    this.applyVignette(imageData, adj.vignette);
                }

                return imageData;
            }

            createCurveLUT() {
                const lut = {
                    rgb: new Uint8Array(256),
                    red: new Uint8Array(256),
                    green: new Uint8Array(256),
                    blue: new Uint8Array(256)
                };

                ['rgb', 'red', 'green', 'blue'].forEach(channel => {
                    const points = this.adjustments.curve[channel];
                    for (let i = 0; i < 256; i++) {
                        lut[channel][i] = this.interpolateCurve(points, i);
                    }
                });

                return lut;
            }

            interpolateCurve(points, x) {
                if (points.length < 2) return x;

                for (let i = 0; i < points.length - 1; i++) {
                    if (x >= points[i][0] && x <= points[i + 1][0]) {
                        const t = (x - points[i][0]) / (points[i + 1][0] - points[i][0]);
                        return Math.round(points[i][1] + t * (points[i + 1][1] - points[i][1]));
                    }
                }
                return x;
            }

            getColorAdjustment(hue, hslSettings) {
                // Map hue to color range
                const h = hue * 360;
                let color = null;

                if (h >= 345 || h < 15) color = 'red';
                else if (h >= 15 && h < 45) color = 'orange';
                else if (h >= 45 && h < 75) color = 'yellow';
                else if (h >= 75 && h < 165) color = 'green';
                else if (h >= 165 && h < 195) color = 'cyan';
                else if (h >= 195 && h < 255) color = 'blue';
                else if (h >= 255 && h < 285) color = 'purple';
                else if (h >= 285 && h < 345) color = 'magenta';

                return color ? hslSettings[color] : null;
            }

            applyGrain(imageData, amount) {
                const data = imageData.data;
                const intensity = amount / 100 * 50;

                for (let i = 0; i < data.length; i += 4) {
                    const noise = (Math.random() - 0.5) * intensity;
                    data[i] = Math.max(0, Math.min(255, data[i] + noise));
                    data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noise));
                    data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noise));
                }
            }

            applyVignette(imageData, amount) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                const centerX = width / 2;
                const centerY = height / 2;
                const maxDist = Math.sqrt(centerX * centerX + centerY * centerY);
                const intensity = amount / 100;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        const dx = x - centerX;
                        const dy = y - centerY;
                        const dist = Math.sqrt(dx * dx + dy * dy) / maxDist;
                        const vignette = 1 - (dist * dist * intensity * 0.8);

                        data[idx] *= vignette;
                        data[idx + 1] *= vignette;
                        data[idx + 2] *= vignette;
                    }
                }
            }

            rgbToHsl(r, g, b) {
                r /= 255; g /= 255; b /= 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;

                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                        case g: h = ((b - r) / d + 2) / 6; break;
                        case b: h = ((r - g) / d + 4) / 6; break;
                    }
                }
                return [h, s, l];
            }

            hslToRgb(h, s, l) {
                let r, g, b;
                if (s === 0) {
                    r = g = b = l;
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    };
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                return [r * 255, g * 255, b * 255];
            }

            hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : { r: 0, g: 0, b: 0 };
            }

            applyFilter(filter) {
                document.querySelectorAll('.preset-card, .film-card').forEach(c => c.classList.remove('active'));
                event.target.closest('.preset-card').classList.add('active');

                this.adjustments.currentPreset = filter;
                Object.entries(filter.settings).forEach(([key, value]) => {
                    if (this.adjustments.hasOwnProperty(key)) {
                        this.adjustments[key] = value * (this.adjustments.presetIntensity / 100);
                        const slider = document.getElementById(key);
                        if (slider) {
                            slider.value = this.adjustments[key];
                            this.updateSliderUI(key, this.adjustments[key], true);
                        }
                    }
                });

                this.saveHistory(`应用滤镜: ${filter.name}`);
                this.render();
            }

            applyFilm(film, brand) {
                document.querySelectorAll('.preset-card, .film-card').forEach(c => c.classList.remove('active'));
                event.target.closest('.film-card').classList.add('active');

                this.adjustments.currentPreset = film;
                Object.entries(film.settings).forEach(([key, value]) => {
                    if (this.adjustments.hasOwnProperty(key)) {
                        this.adjustments[key] = value * (this.adjustments.presetIntensity / 100);
                        const slider = document.getElementById(key);
                        if (slider) {
                            slider.value = this.adjustments[key];
                            this.updateSliderUI(key, this.adjustments[key], true);
                        }
                    }
                });

                this.saveHistory(`应用胶片: ${brand} ${film.name}`);
                this.render();
            }

            filterPresets(category) {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');

                document.querySelectorAll('.preset-section').forEach(section => {
                    const types = section.dataset.type?.split(' ') || [];
                    if (category === 'all' || types.includes(category)) {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                });
            }

            searchPresets(query) {
                const q = query.toLowerCase();
                document.querySelectorAll('.preset-card, .film-card').forEach(card => {
                    const name = card.querySelector('.preset-name, .film-name')?.textContent.toLowerCase() || '';
                    const brand = card.querySelector('.film-brand')?.textContent.toLowerCase() || '';
                    if (name.includes(q) || brand.includes(q)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }

            setZoom(zoom) {
                this.zoom = Math.max(0.25, Math.min(4, zoom));
                document.getElementById('zoomLevel').textContent = Math.round(this.zoom * 100) + '%';
                this.canvas.style.transform = `scale(${this.zoom})`;
            }

            saveHistory(action) {
                // Remove any future history if we're not at the end
                this.history = this.history.slice(0, this.historyIndex + 1);
                
                this.history.push({
                    action,
                    adjustments: JSON.parse(JSON.stringify(this.adjustments)),
                    timestamp: new Date()
                });
                this.historyIndex = this.history.length - 1;
                this.updateHistoryPanel();
            }

            updateHistoryPanel() {
                const list = document.getElementById('historyList');
                list.innerHTML = this.history.map((item, index) => `
                    <div class="history-item ${index === this.historyIndex ? 'active' : ''}" data-index="${index}">
                        <div class="history-thumb">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </div>
                        <div class="history-info">
                            <div class="history-action">${item.action}</div>
                            <div class="history-time">${item.timestamp.toLocaleTimeString()}</div>
                        </div>
                    </div>
                `).join('');

                list.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.goToHistory(parseInt(item.dataset.index));
                    });
                });
            }

            goToHistory(index) {
                if (index < 0 || index >= this.history.length) return;
                this.historyIndex = index;
                this.adjustments = JSON.parse(JSON.stringify(this.history[index].adjustments));
                this.updateAllSliders();
                this.render();
                this.updateHistoryPanel();
            }

            undo() {
                if (this.historyIndex > 0) {
                    this.goToHistory(this.historyIndex - 1);
                }
            }

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.goToHistory(this.historyIndex + 1);
                }
            }

            updateAllSliders() {
                const sliders = [
                    'exposure', 'contrast', 'highlights', 'shadows', 'whites', 'blacks',
                    'temperature', 'tint', 'vibrance', 'saturation',
                    'clarity', 'dehaze', 'sharpen', 'noiseReduction', 'vignette', 'grain',
                    'highlightTone', 'shadowTone', 'toneBalance'
                ];

                sliders.forEach(id => {
                    const slider = document.getElementById(id);
                    if (slider && this.adjustments[id] !== undefined) {
                        slider.value = this.adjustments[id];
                        const centered = !['sharpen', 'noiseReduction', 'grain', 'highlightTone', 'shadowTone'].includes(id);
                        this.updateSliderUI(id, this.adjustments[id], centered);
                    }
                });

                document.getElementById('intensity').value = this.adjustments.presetIntensity;
                this.updateSliderUI('intensity', this.adjustments.presetIntensity, false, true);
            }

            resetAdjustments() {
                const defaults = {
                    exposure: 0, contrast: 0, highlights: 0, shadows: 0, whites: 0, blacks: 0,
                    temperature: 0, tint: 0, vibrance: 0, saturation: 0,
                    clarity: 0, dehaze: 0, sharpen: 0, noiseReduction: 0, vignette: 0, grain: 0
                };

                Object.assign(this.adjustments, defaults);
                this.updateAllSliders();
                this.saveHistory('重置所有调整');
                this.render();
            }

            resetCurve() {
                this.adjustments.curve = {
                    rgb: [[0, 0], [255, 255]],
                    red: [[0, 0], [255, 255]],
                    green: [[0, 0], [255, 255]],
                    blue: [[0, 0], [255, 255]]
                };
                this.drawCurve();
                this.saveHistory('重置曲线');
                this.render();
            }

            resetHSL() {
                const colors = ['red', 'orange', 'yellow', 'green', 'cyan', 'blue', 'purple', 'magenta'];
                colors.forEach(color => {
                    this.adjustments.hsl[color] = { hue: 0, sat: 0, lum: 0 };
                    const slider = document.getElementById(`${color}Hue`);
                    if (slider) {
                        slider.value = 0;
                        this.updateSliderUI(`${color}Hue`, 0, true);
                    }
                });
                this.saveHistory('重置 HSL');
                this.render();
            }

            resetSplitToning() {
                this.adjustments.highlightColor = '#ffaa00';
                this.adjustments.highlightTone = 0;
                this.adjustments.shadowColor = '#0066ff';
                this.adjustments.shadowTone = 0;
                this.adjustments.toneBalance = 0;

                document.getElementById('highlightColor').value = '#ffaa00';
                document.getElementById('highlightColorDisplay').style.background = '#ffaa00';
                document.getElementById('shadowColor').value = '#0066ff';
                document.getElementById('shadowColorDisplay').style.background = '#0066ff';

                ['highlightTone', 'shadowTone', 'toneBalance'].forEach(id => {
                    const slider = document.getElementById(id);
                    slider.value = id === 'toneBalance' ? 0 : 0;
                    this.updateSliderUI(id, 0, id === 'toneBalance');
                });

                this.saveHistory('重置色彩分离');
                this.render();
            }

            exportImage() {
                if (!this.originalImage) return;

                const link = document.createElement('a');
                link.download = 'photostudio_export.png';
                link.href = this.canvas.toDataURL('image/png');
                link.click();
            }

            initCurveEditor() {
                this.curveCanvas = document.getElementById('curveCanvas');
                if (!this.curveCanvas) return;

                this.curveCtx = this.curveCanvas.getContext('2d');
                this.currentCurveChannel = 'rgb';

                // Set canvas size
                const wrapper = this.curveCanvas.parentElement;
                this.curveCanvas.width = wrapper.clientWidth;
                this.curveCanvas.height = wrapper.clientWidth;

                this.drawCurve();

                // Curve channel selection
                document.querySelectorAll('.curve-preset[data-curve]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.curve-preset[data-curve]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentCurveChannel = btn.dataset.curve;
                        this.drawCurve();
                    });
                });

                // Curve presets
                document.querySelectorAll('.curve-preset[data-preset]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.applyCurvePreset(btn.dataset.preset);
                    });
                });

                // Curve interaction
                let isDragging = false;
                let dragPoint = -1;

                this.curveCanvas.addEventListener('mousedown', (e) => {
                    const rect = this.curveCanvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width * 255;
                    const y = 255 - (e.clientY - rect.top) / rect.height * 255;

                    const points = this.adjustments.curve[this.currentCurveChannel];
                    
                    // Check if clicking near existing point
                    dragPoint = points.findIndex(p => 
                        Math.abs(p[0] - x) < 15 && Math.abs(p[1] - y) < 15
                    );

                    if (dragPoint === -1 && points.length < 10) {
                        // Add new point
                        points.push([Math.round(x), Math.round(y)]);
                        points.sort((a, b) => a[0] - b[0]);
                        dragPoint = points.findIndex(p => p[0] === Math.round(x));
                    }

                    isDragging = true;
                });

                this.curveCanvas.addEventListener('mousemove', (e) => {
                    if (!isDragging || dragPoint === -1) return;

                    const rect = this.curveCanvas.getBoundingClientRect();
                    const x = Math.max(0, Math.min(255, (e.clientX - rect.left) / rect.width * 255));
                    const y = Math.max(0, Math.min(255, 255 - (e.clientY - rect.top) / rect.height * 255));

                    const points = this.adjustments.curve[this.currentCurveChannel];
                    
                    // Don't allow moving first/last point horizontally
                    if (dragPoint === 0) {
                        points[dragPoint][1] = Math.round(y);
                    } else if (dragPoint === points.length - 1) {
                        points[dragPoint][1] = Math.round(y);
                    } else {
                        points[dragPoint] = [Math.round(x), Math.round(y)];
                    }

                    this.drawCurve();
                    this.render();
                });

                this.curveCanvas.addEventListener('mouseup', () => {
                    if (isDragging) {
                        this.saveHistory('调整曲线');
                    }
                    isDragging = false;
                    dragPoint = -1;
                });

                this.curveCanvas.addEventListener('dblclick', (e) => {
                    const rect = this.curveCanvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width * 255;
                    const y = 255 - (e.clientY - rect.top) / rect.height * 255;

                    const points = this.adjustments.curve[this.currentCurveChannel];
                    const pointIndex = points.findIndex(p => 
                        Math.abs(p[0] - x) < 15 && Math.abs(p[1] - y) < 15
                    );

                    if (pointIndex > 0 && pointIndex < points.length - 1) {
                        points.splice(pointIndex, 1);
                        this.drawCurve();
                        this.saveHistory('删除曲线点');
                        this.render();
                    }
                });
            }

            drawCurve() {
                if (!this.curveCtx) return;

                const ctx = this.curveCtx;
                const w = this.curveCanvas.width;
                const h = this.curveCanvas.height;

                // Clear
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, w, h);

                // Grid
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                for (let i = 1; i < 4; i++) {
                    const pos = (w / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(pos, 0);
                    ctx.lineTo(pos, h);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(0, pos);
                    ctx.lineTo(w, pos);
                    ctx.stroke();
                }

                // Diagonal line
                ctx.strokeStyle = '#444';
                ctx.beginPath();
                ctx.moveTo(0, h);
                ctx.lineTo(w, 0);
                ctx.stroke();

                // Curve
                const points = this.adjustments.curve[this.currentCurveChannel];
                const colors = {
                    rgb: '#fff',
                    red: '#ef4444',
                    green: '#22c55e',
                    blue: '#3b82f6'
                };

                ctx.strokeStyle = colors[this.currentCurveChannel];
                ctx.lineWidth = 2;
                ctx.beginPath();

                for (let x = 0; x < 256; x++) {
                    const y = this.interpolateCurve(points, x);
                    const px = (x / 255) * w;
                    const py = h - (y / 255) * h;
                    if (x === 0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                }
                ctx.stroke();

                // Points
                points.forEach(([x, y]) => {
                    const px = (x / 255) * w;
                    const py = h - (y / 255) * h;
                    
                    ctx.fillStyle = colors[this.currentCurveChannel];
                    ctx.beginPath();
                    ctx.arc(px, py, 6, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#1a1a1a';
                    ctx.beginPath();
                    ctx.arc(px, py, 3, 0, Math.PI * 2);
                    ctx.fill();
                });
            }

            applyCurvePreset(preset) {
                const presets = {
                    linear: [[0, 0], [255, 255]],
                    contrast: [[0, 0], [64, 48], [192, 208], [255, 255]],
                    fade: [[0, 32], [255, 224]],
                    film: [[0, 16], [32, 32], [224, 224], [255, 240]],
                    cross: [[0, 0], [64, 96], [192, 160], [255, 255]],
                    vintage: [[0, 24], [128, 128], [255, 232]]
                };

                if (presets[preset]) {
                    this.adjustments.curve[this.currentCurveChannel] = [...presets[preset]];
                    this.drawCurve();
                    this.saveHistory(`应用曲线预设: ${preset}`);
                    this.render();
                }
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            window.photoStudio = new PhotoStudio();
        });
    </script>
</body>
</html>
